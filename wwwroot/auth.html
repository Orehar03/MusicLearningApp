<script>
    // --- Функции для переключения форм (оставляем без изменений) ---
    function showRegister() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
        resetStatusMessages();
    }
    function showLogin() {
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
        resetStatusMessages();
    }
    function resetStatusMessages() {
        document.getElementById('login-status').style.display = 'none';
        document.getElementById('login-status').textContent = '';
        document.getElementById('register-status').style.display = 'none';
        document.getElementById('register-status').textContent = '';
    }
    document.getElementById('reg-birthdate').addEventListener('input', function (e) {
        let v = e.target.value.replace(/\D/g, '');
        if (v.length >= 2) v = v.substring(0, 2) + '.' + v.substring(2);
        if (v.length >= 5) v = v.substring(0, 5) + '.' + v.substring(5, 9);
        e.target.value = v.substring(0, 10);
    });

    // --- НОВАЯ, МАКСИМАЛЬНО ПРОСТАЯ ФУНКЦИЯ ВХОДА ---
    async function login() {
        console.log("LOGIN: Функция login() вызвана");

        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const status = document.getElementById('login-status');

        console.log("LOGIN: Email и пароль получены:", email);

        if (!email || !password) {
            console.log("LOGIN: Поля не заполнены");
            status.textContent = 'Заполните все поля';
            status.style.display = 'block';
            return;
        }

        status.textContent = 'Попытка входа...';
        status.style.display = 'block';

        try {
            console.log("LOGIN: Отправка запроса на сервер...");
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            console.log("LOGIN: Ответ от сервера получен. Статус:", response.status);

            const data = await response.json();
            console.log("LOGIN: Данные ответа:", data);

            if (response.ok) {
                console.log("LOGIN: Ответ успешный. Проверяю наличие токена...");

                // Проверяем, есть ли токен в ответе
                if (data && data.Token) {
                    console.log("LOGIN: Токен найден. Пытаюсь сохранить в localStorage...");
                    localStorage.setItem('authToken', data.Token);

                    // Проверяем, сохранился ли он
                    const savedToken = localStorage.getItem('authToken');
                    if (savedToken) {
                        console.log("LOGIN: Успех! Токен сохранён в localStorage:", savedToken);
                        status.textContent = 'Вход успешен! Перенаправление...';
                        window.location.href = '/';
                    } else {
                        console.error("LOGIN: ОШИБКА! Токен не сохранился в localStorage.");
                        status.textContent = 'Ошибка: не удалось сохранить токен. Попробуйте ещё раз.';
                    }
                } else {
                    console.error("LOGIN: ОШИБКА! В ответе сервера нет токена.");
                    status.textContent = 'Ошибка: сервер не вернул токен.';
                }
            } else {
                console.error("LOGIN: Ошибка входа. Сервер вернул:", data);
                status.textContent = data.error || 'Неверные данные';
            }
        } catch (error) {
            console.error("LOGIN: Произошла непредвиденная ошибка:", error);
            status.textContent = 'Ошибка подключения к серверу';
        }
    }

    // ... функцию register можно пока оставить как есть или временно убрать ...
    async function register() {
        // ... (код функции register без изменений) ...
        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const birthDateStr = document.getElementById('reg-birthdate').value;

        const status = document.getElementById('register-status');
        resetStatusMessages();

        if (!name || !email || !password || !birthDateStr) {
            showStatus(status, 'Заполните все поля', 'error');
            return;
        }

        const parts = birthDateStr.split('.');
        if (parts.length !== 3 || parts[0].length !== 2 || parts[1].length !== 2 || parts[2].length !== 4) {
            showStatus(status, 'Формат даты: ДД.ММ.ГГГГ', 'error');
            return;
        }

        const birthDate = `${parts[2]}-${parts[1]}-${parts[0]}`;

        status.textContent = 'Регистрация...';
        status.style.display = 'block';
        status.className = 'status-error';

        try {
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, name, gender, birthDate })
            });
            const data = await res.json();
            if (res.ok) {
                showStatus(status, 'Регистрация успешна! Теперь войдите.', 'success');
                setTimeout(showLogin, 1000);
            } else {
                showStatus(status, data.error || 'Ошибка регистрации', 'error');
            }
        } catch (err) {
            showStatus(status, 'Ошибка подключения к серверу', 'error');
            console.error('Register error:', err);
        }
    }
    function showStatus(element, message, type) {
        element.textContent = message;
        element.style.display = 'block';
        element.className = type === 'success' ? 'status-success' : 'status-error';
    }
</script>